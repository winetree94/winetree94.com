---
import BaseHead from "@/components/BaseHead.astro";
import BlogHeader from "@/components/BlogHeader.astro";
import type {
  GetStaticPaths,
  InferGetStaticParamsType,
  InferGetStaticPropsType,
} from "astro";
import { ghost } from "@/lib/ghost.ts";
import { SUPPORTED_LANGUAGES } from "@/lib/language";
import { SITE_DESCRIPTION, SITE_TITLE } from "@/consts";
import Footer from "@/components/Footer.astro";
import TextDate from "@/components/TextDate.astro";
import { useTranslation } from "@/i18n/utils";
import { Image } from "astro:assets";

export const getStaticPaths = (async () => {
  const tags = await ghost.tags.browse({
    limit: 100,
  });

  const langs = Object.values(SUPPORTED_LANGUAGES);
  const posts = await Promise.all(
    langs.map(async (lang) => {
      const langPosts = await Promise.all(
        tags.map(async (tag) => {
          const tagPosts = await ghost.posts.browse({
            limit: 100,
            filter: `tag:${lang}+tag:${tag.slug}`,
          });

          if (!tagPosts) {
            throw new Error("Post not found");
          }

          return {
            params: {
              lang: lang,
              tag: tag.slug,
            },
            props: {
              tag: tag,
              posts: tagPosts,
            },
          };
        })
      ).then((res) => res.flat());
      return langPosts;
    })
  ).then((res) => res.flat());

  return posts;
}) satisfies GetStaticPaths;

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;
const t = useTranslation(Astro.params.lang);
---

<!doctype html>
<html lang={Astro.params.lang}>
  <head>
    <BaseHead
      title={SITE_TITLE}
      description={SITE_DESCRIPTION}
      lang={Astro.params.lang}
    />
  </head>
  <body>
    <BlogHeader lang={Astro.params.lang} />
    <main class="w-full flex justify-center mt-18">
      <article class="flex flex-col max-w-[720px] w-full px-4">
        {
          t(`tags.${Astro.props.tag.slug}.title`) && (
            <div class="flex flex-col items-center justify-center gap-4">
              <h1 class="text-3xl whitespace-pre-line">
                {t(`tags.${Astro.props.tag.slug}.title`)}
              </h1>
              <p class="text-lg whitespace-pre-line">
                {t(`tags.${Astro.props.tag.slug}.description`)}
              </p>
            </div>
          )
        }
        {
          Astro.props.posts.length ? (
            <ul class="flex flex-wrap gap-8 list-none mt-8">
              {Astro.props.posts.map((post) => (
                <li class="w-full sm:w-[calc(50%-1rem)]">
                  <a
                    class="flex flex-col"
                    href={`/${Astro.params.lang}/article/${post.slug.slice(3)}/`}
                  >
                    <Image
                      class="rounded-xl aspect-video object-cover w-full"
                      width={480}
                      height={270}
                      src={post.feature_image!}
                      alt="featured image"
                    />
                    <h6 class="title mt-4">{post.title}</h6>
                    <p class="date">
                      <TextDate
                        lang={Astro.params.lang}
                        date={post.published_at!}
                      />
                    </p>
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <div class="flex justify-center">
              <p>{t("global.empty")}</p>
            </div>
          )
        }
      </article>
    </main>
    <Footer />
  </body>
</html>
