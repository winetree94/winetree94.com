---
import { ghost } from "@/lib/ghost.ts";
import type {
  GetStaticPaths,
  InferGetStaticParamsType,
  InferGetStaticPropsType,
} from "astro";
import { SUPPORTED_LANGUAGES } from "@/lib/language";
import BlogArticle from "@/components/BlogArticle.astro";

export const getStaticPaths = (async () => {
  const langs = Object.values(SUPPORTED_LANGUAGES);

  const posts = await Promise.all(
    langs.map(async (lang) => {
      const langPosts = await ghost.posts.browse({
        limit: 100,
        filter: `tag:${lang}`,
      });

      if (!langPosts) {
        throw new Error("Post not found");
      }

      return langPosts.map((post) => {
        return {
          params: {
            lang: lang,
            slug: post.slug.replace(`${lang}-`, ""),
          },
          props: {
            post: post,
          },
        };
      });
    })
  ).then((res) => res.flat());

  return posts;
}) satisfies GetStaticPaths;

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { post } = Astro.props;
---

<BlogArticle lang={Astro.params.lang} post={post} useComments={true} />
