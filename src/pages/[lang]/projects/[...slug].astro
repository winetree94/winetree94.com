---
import { ghost } from "@/lib/ghost.ts";
import BaseHead from "@/components/BaseHead.astro";
import BlogHeader from "@/components/header/BlogHeader.astro";
import type {
  GetStaticPaths,
  InferGetStaticParamsType,
  InferGetStaticPropsType,
} from "astro";
import { SUPPORTED_LANGUAGES } from "@/lib/language";
import Footer from "@/components/Footer.astro";
import SearchDaemon from "@/components/SearchDaemon.astro";
import GhostPost from "@/components/GhostPost.astro";
import ArticleHead from "@/components/ArticleHead.astro";
import { highlightGhostHTML } from "@/lib/highlight";

export const getStaticPaths = (async () => {
  const res = await Promise.all(
    Object.values(SUPPORTED_LANGUAGES).map(async (lang) => {
      const posts = await ghost.posts.browse({
        limit: 100,
        filter: `tag:${lang}+tag:project`,
      });

      if (!posts) {
        throw new Error("Post not found");
      }

      return posts.map((post) => {
        return {
          params: {
            lang: lang,
            slug: post.slug.replace(`${lang}-`, ""),
          },
          props: {
            post: post,
          },
        };
      });
    })
  );

  return res.flat();
}) satisfies GetStaticPaths;

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { post } = Astro.props;
const highlightedHTML = await highlightGhostHTML(post.html || "");
---

<html lang={Astro.params.lang}>
  <head>
    <BaseHead
      title={Astro.props.post.title!}
      description={Astro.props.post.excerpt!}
      ogImageUrl={Astro.props.post.feature_image || undefined}
      lang={Astro.params.lang}
    />
  </head>

  <body>
    <BlogHeader lang={Astro.params.lang} />
    <main class="w-full max-w-full">
      <article>
        <img
          class="w-full max-w-full aspect-21/9 object-cover"
          src={post.feature_image}
        />
        <div class="max-w-[720px] m-auto">
          <ArticleHead
            class:list="mt-4"
            lang={Astro.params.lang}
            createdAt={post.published_at!}
            updatedAt={post.updated_at}
            title={post.title!}
          />
          <GhostPost>
            <Fragment set:html={highlightedHTML} />
          </GhostPost>
          <div class="mt-16">
            <script
              src="https://giscus.app/client.js"
              data-repo="winetree94/winetree94.com"
              data-repo-id="R_kgDOMQZteg"
              data-category="Announcements"
              data-category-id="DIC_kwDOMQZtes4Cg0or"
              data-mapping={Astro.url.pathname}
              data-strict="1"
              data-reactions-enabled="1"
              data-emit-metadata="0"
              data-input-position="bottom"
              data-theme="light"
              data-lang={Astro.params.lang}
              crossorigin="anonymous"
              async></script>
          </div>
        </div>
      </article>
    </main>
    <Footer />
    <SearchDaemon />
  </body>
</html>
